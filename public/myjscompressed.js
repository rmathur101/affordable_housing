function isUndefinedOrNull(e){return _.isUndefined(e)||_.isNull(e)}$(document).ready(function(){function e(e){$.ajax({type:"POST",url:"/log_data",data:{data:{action:e,district:$("#select-district").val(),datepicker1:$("#datepicker1").val(),datepicker2:$("#datepicker2").val(),income:$("#household-yearly-income").val(),IPDATA:b}},success:function(e){},error:function(){}})}function t(){$("#datepicker1").datepicker({defaultDate:$.datepicker.formatDate("MM dd, yy",new Date)}),$("#datepicker1").val($.datepicker.formatDate("m/dd/yy",new Date));var t=$.datepicker.formatDate("m/dd/yy",new Date("2100-01-01"));$("#datepicker2").datepicker({defaultDate:t}),$("#datepicker2").val(t),mymap=L.map("mapid").setView([30.310768,-97.674724],11),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:"pk.eyJ1Ijoicm1hdGh1cjEwMSIsImEiOiJjajg3a3I0cjIwb2lqMndtdGVtaWx1ZjZrIn0.iEel0XmzyrU4fz78lEQ3GQ"}).addTo(mymap),L.AwesomeMarkers.Icon.prototype.options.prefix="ion",w=JSON.parse(jsonAHIObject),h=p(w,mymap),$("#search-matching-properties").click(function(){o(),e("Search Matching Properties")})}function o(){function e(e){return function(t){return t["Council District"]==parseInt(e)}}console.log("district");var t=$("#select-district").val();g(h,mymap),h="ALL"==t?p(w,mymap):p(w,mymap,e(t))}function a(e,t){var o=[];for(d in e){var a=e[d];a.Location&&a.Location.length>0&&t(a)&&o.push(a)}return o}function i(){this.unbindPopup();var e=this.markerID,t=A[e],o="",a="green";t["Project Name"]&&(o+='<div><b style="color: '+a+';">Project Name: </b>'+t["Project Name"]+"</div>"),t.Address&&t["Zip Code"]&&(o+='<div><b style="color: '+a+';">Address: </b>'+t.Address+"Austin, TX"+t["Zip Code"]+"</div>"),t.Owner&&(o+='<div><b style="color: '+a+';">Owner: </b>'+t.Owner+"</div>"),t.Developer&&(o+='<div><b style="color: '+a+';">Developer: </b>'+t.Developer+"</div>"),t.Status&&(o+='<div><b style="color: '+a+';">Status: </b>'+t.Status+"</div>"),t["Housing Type"]&&(o+='<div><b style="color: '+a+';">Housing Type: </b>'+t["Housing Type"]+"</div>"),t["Unit Type"]&&(o+='<div><b style="color: '+a+';">Unit Type: </b>'+t["Unit Type"]+"</div>"),t["Distance to Bus Stop"]&&(o+='<div><b style="color: '+a+';">Distance to Bus Stop:</b> '+t["Distance to Bus Stop"]+"</div>"),t["Affordability Expiration Date"]&&(o+='<div><b style="color: '+a+';">Affordability Expiration Date: </b>'+t["Affordability Expiration Date"]+"</div>"),t["City Funded Amount"]&&(o+='<div><b style="color: '+a+';">City Funded Amount: </b>'+t["City Funded Amount"]+"</div>"),this.bindPopup(o),this.openPopup()}function r(e,t,o){var a=0;for(n in e){var i=e[n];if(!_.isUndefined(i[t])&&!_.isNull(i[t])){var r=i[t];_.isUndefined(o)||(r=o(r)),a+=r}}return a}function l(e){var t={};for(var o in e){var a=e[o];if(!_.isUndefined(a["Kirwan Opportunity Index"])&&!_.isNull(a["Kirwan Opportunity Index"])&&a["Kirwan Opportunity Index"].length>0&&!_.isUndefined(a["Total Affordable Units"])&&a["Total Affordable Units"]>=0&&!_.isUndefined(a["Market Rate Units"]&&a["Market Rate Units"])){var n=a["Kirwan Opportunity Index"];n in t||(t[n]={market:0,affordable:0}),n in t&&(t[n].market=a["Market Rate Units"],t[n].affordable=a["Total Affordable Units"])}}return t}function s(e,t){var o={};for(var a in e){var n=e[a];if(!_.isUndefined(n.Program&&!_.isNull(n.Program))&&!_.isUndefined(n["Total Affordable Units"])&&n["Total Affordable Units"]>=0){var i=n.Program;i in o||(o[i]={affordable:0,cityFundedAmount:0}),i in o&&(o[i].affordable=o[i].affordable+n["Total Affordable Units"],o[i].cityFundedAmount=o[i].cityFundedAmount+t(n["City Funded Amount"]))}}return o}function c(e,t){var o={};for(var a in e){var n=e[a];if(!isUndefinedOrNull(n.Developer&&!isUndefinedOrNull(n["Total Affordable Units"]))){var i=n.Developer;i in o||(o[i]={affordable:0,cityFundedAmount:0,RHDA:0,AD:0,Incentive:0,devName:i,veryLow:0,low:0,moderate:0,high:0,veryHigh:0,total:0}),i in o&&(o[i].affordable=o[i].affordable+n["Total Affordable Units"],isUndefinedOrNull(n["City Funded Amount"])||(o[i].cityFundedAmount=o[i].cityFundedAmount+t(n["City Funded Amount"])),"RHDA"==n.Program&&(o[i].RHDA=o[i].RHDA+n["Total Affordable Units"]),"A&D"==n.Program&&(o[i].AD=o[i].AD+n["Total Affordable Units"]),"Devloper Incentive"==n.Program&&(o[i].Incentive=o[i].Incentive+n["Total Affordable Units"]),"Very Low"==n["Kirwan Opportunity Index"]&&(o[i].veryLow=o[i].veryLow+n["Total Affordable Units"]),"Low"==n["Kirwan Opportunity Index"]&&(o[i].low=o[i].low+n["Total Affordable Units"]),"Moderate"==n["Kirwan Opportunity Index"]&&(o[i].moderate=o[i].moderate+n["Total Affordable Units"]),"High"==n["Kirwan Opportunity Index"]&&(o[i].high=o[i].high+n["Total Affordable Units"]),"Very High"==n["Kirwan Opportunity Index"]&&(o[i].veryHigh=o[i].veryHigh+n["Total Affordable Units"]),o[i].total=o[i].total+n["Total Units"])}}var r=[];for(var l in o)r.push(o[l]);return _.sortBy(r,"affordable").reverse()}function u(){$("#data-content").toggle(!1),$("#loader").toggle(!0)}function f(){setTimeout(function(){$("#data-content").toggle(!0),$("#loader").toggle(!1)},1e3)}function p(e,t,o){console.log("data"),console.log(e);var n=function(e){return parseFloat(e.replace("$",""))},d=c(e,n);console.log(d),u();var p=new L.FeatureGroup;if(o)g=a(e,o);else var g=e;g=a(g,function(e){function t(e,t,o){return o>=e&&o<=t}function o(e){var t=83e3,o=$("#household-yearly-income").val();if(o){var a=parseFloat(o/t*100);console.log(a);var n=[];a<80&&n.push(80),a<60&&n.push(60),a<50&&n.push(50),a<40&&n.push(40);var i=0;return _.contains(n,80)||(i+=e["Units <= 80% MFI"]),_.contains(n,60)||(i+=e["Units <= 80% MFI"]),_.contains(n,60)||(i+=e["Units <= 60% MFI"]),_.contains(n,50)||(i+=e["Units <= 50% MFI"]),_.contains(n,40)||(i+=e["Units <= 40% MFI"]),(i+=e["Units <= 30% MFI"])>0}return!0}var a=new Date($("#datepicker1").val()),n=new Date($("#datepicker2").val());return(!_.isUndefined(e["Affordability Expiration Date"])||!_.isNull(e["Affordability Expiration Date"]))&&!(!t(a,n,new Date(e["Affordability Expiration Date"]))||!o(e))}),A=g;var v=0,b=r(g,"Total Affordable Units"),y=r(g,"Market Rate Units"),h=r(g,"Units <= 30% MFI"),w=r(g,"Units <= 40% MFI"),U=r(g,"Units <= 50% MFI"),k=r(g,"Units <= 60% MFI"),I=(r(g,"Units <= 80% MFI"),r(g,"City Funded Amount",n));console.log("city funded amount"),console.log(I),$("#city-funded-amount-total").text(I);var D=l(g);console.log(D);var F=s(g,n);console.log(F);for(var T in g){var x=g[T];if(x.Location&&x.Location.length>0){var C=x.Location.match(/\d*\.\d*/g),O=L.marker([parseFloat(C[0]),-parseFloat(C[1])],{icon:m()});O.markerID=T,O.on("click",i),p.addLayer(O),v+=1}}t.addLayer(p),$("#AFI-Total").text(v),$("#AFI-Affordable").text(b),$("#AFI-Market-Rate-Units").text(y);var M=550;return google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["<= 30% MFI",h],["<= 40% MFI",w],["<= 50% MFI",U],["<= 60% MFI",k]]);var t={title:"Affordable Housing By Income Level",width:M,height:300};new google.visualization.ColumnChart(document.getElementById("chart_div")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["Very Low",isUndefinedOrNull(D["Very Low"])?0:D["Very Low"].affordable],["Low",isUndefinedOrNull(D.Low)?0:D.Low.affordable],["Moderate",isUndefinedOrNull(D.Moderate)?0:D.Moderate.affordable],["High",isUndefinedOrNull(D.High)?0:D.High.affordable],["Very High",isUndefinedOrNull(D["Very High"])?0:D["Very High"].affordable]]);var t={title:"Affordable Housing By Kirwan Opportunity Index",width:M,height:300,colors:["orange"],legend:"right"};new google.visualization.ColumnChart(document.getElementById("chart-kirwan")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["RHDA",isUndefinedOrNull(F.RHDA)?0:F.RHDA.affordable],["A&D",isUndefinedOrNull(F["A&D"])?0:F["A&D"].affordable],["Developer Incentive",isUndefinedOrNull(F["Developer Incentive"])?0:F["Developer Incentive"].affordable]]);var t={title:"Affordable Housing By Program Type",width:M,height:300,colors:["red"]};new google.visualization.ColumnChart(document.getElementById("chart-program")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Developer Name"),e.addColumn("number","City Funded Amount ($)"),e.addColumn("number","Affordable Units"),e.addColumn("number","Total Units"),e.addColumn("number","City Cost Per Unit");var t=[];for(T in d){var o=d[T],a=0;o.cityFundedAmount>0&&o.total>0&&(console.log(o.cityFundedAmount),console.log(o.affordable),a=parseFloat((o.cityFundedAmount/o.total).toFixed(2)),console.log(a)),t.push([o.devName,o.cityFundedAmount,o.affordable,o.total,a])}e.addRows(t),new google.visualization.Table(document.getElementById("developer_table")).draw(e,{showRowNumber:!0,width:"100%",height:"500px"});var n=$(".google-visualization-table-table > tbody > tr");$.each(n,function(){var e=$(this).children("td"),t=e[e.length-1];parseFloat($(t).text())>0&&$(t).css("background-color","#5cb85c")}),$("#developer_table").off(),$("#developer_table").click(function(){var e=$(".google-visualization-table-table > tbody > tr");$.each(e,function(){var e=$(this).children("td"),t=e[e.length-1];parseFloat($(t).text())>0&&$(t).css("background-color","#5cb85c")})})}),f(),p}function g(e,t){t.removeLayer(e)}function m(e){return v()}function v(e){return L.AwesomeMarkers.icon({markerColor:"blue"})}var b=null;$.ajax({type:"GET",url:"https://freegeoip.net/json/?callback",success:function(t){b=t,e("IP DATA ONLY"),console.log(t)},error:function(){}}),$('[data-toggle="tooltip"]').tooltip({}),$("#submit-login").click(function(){$.ajax({type:"POST",url:"/login",data:{pass:$("#pass-input").val()},success:function(e){console.log("login success"),$("#main-app").toggle(!0),$("#login").toggle(!1),t()},error:function(){console.log("login error")}})});var y={show_email:!0,show_name:!1,position:"right-top",email_placeholder:"Email goes here (optional)",message_placeholder:"Go ahead, type your feedback here...",name_required:!1,message_required:!0,message_label:"Questions, comments, suggestions?",show_asterisk_for_required:!0,feedback_url:"send_feedback",delayed_options:{delay_success_milliseconds:3500,send_success:"Sent successfully :)"}};fm.init(y),$(".feedback_trigger").css("color","white"),$(".feedback_trigger").css("background","green"),$(".feedback_trigger").css("height","105px"),$(".feedback_content").css("border","2px solid black"),$(".feedback_submit").css("background","green"),f(),google.charts.load("current",{packages:["corechart","table"]});var h=null,A=[];mymap=null;var w=null});
