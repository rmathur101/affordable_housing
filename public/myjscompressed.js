function isUndefinedOrNull(e){return _.isUndefined(e)||_.isNull(e)}$(document).ready(function(){function e(e){$.ajax({type:"POST",url:"/log_data",data:{data:{action:e,district:$("#select-district").val(),datepicker1:$("#datepicker1").val(),datepicker2:$("#datepicker2").val(),income:$("#household-yearly-income").val(),IPDATA:b,loginPass:window.loginPass}},success:function(e){},error:function(){}})}function t(){$("#datepicker1").datepicker({defaultDate:$.datepicker.formatDate("MM dd, yy",new Date)}),$("#datepicker1").val($.datepicker.formatDate("m/dd/yy",new Date));var t=$.datepicker.formatDate("m/dd/yy",new Date("2100-01-01"));$("#datepicker2").datepicker({defaultDate:t}),$("#datepicker2").val(t),mymap=L.map("mapid").setView([30.310768,-97.674724],11),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',maxZoom:18,id:"mapbox.streets",accessToken:"pk.eyJ1Ijoicm1hdGh1cjEwMSIsImEiOiJjajg3a3I0cjIwb2lqMndtdGVtaWx1ZjZrIn0.iEel0XmzyrU4fz78lEQ3GQ"}).addTo(mymap),L.AwesomeMarkers.Icon.prototype.options.prefix="ion",w=JSON.parse(jsonAHIObject),h=p(w,mymap),$("#search-matching-properties").click(function(){a(),e("Search Matching Properties")})}function a(){function e(e){return function(t){return t["Council District"]==parseInt(e)}}var t=$("#select-district").val();m(h,mymap),h="ALL"==t?p(w,mymap):p(w,mymap,e(t))}function o(e,t){var a=[];for(d in e){var n=e[d];n.Location&&n.Location.length>0&&t(n)&&a.push(n)}return a}function i(){this.unbindPopup();var e=this.markerID,t=A[e],a="",n="green";t["Project Name"]&&(a+='<div><b style="color: '+n+';">Project Name: </b>'+t["Project Name"]+"</div>"),t.Address&&t["Zip Code"]&&(a+='<div><b style="color: '+n+';">Address: </b>'+t.Address+"Austin, TX"+t["Zip Code"]+"</div>"),t.Owner&&(a+='<div><b style="color: '+n+';">Owner: </b>'+t.Owner+"</div>"),t.Developer&&(a+='<div><b style="color: '+n+';">Developer: </b>'+t.Developer+"</div>"),t.Status&&(a+='<div><b style="color: '+n+';">Status: </b>'+t.Status+"</div>"),t["Housing Type"]&&(a+='<div><b style="color: '+n+';">Housing Type: </b>'+t["Housing Type"]+"</div>"),t["Unit Type"]&&(a+='<div><b style="color: '+n+';">Unit Type: </b>'+t["Unit Type"]+"</div>"),t["Distance to Bus Stop"]&&(a+='<div><b style="color: '+n+';">Distance to Bus Stop:</b> '+t["Distance to Bus Stop"]+"</div>"),t["Affordability Expiration Date"]&&(a+='<div><b style="color: '+n+';">Affordability Expiration Date: </b>'+t["Affordability Expiration Date"]+"</div>"),t["City Funded Amount"]&&(a+='<div><b style="color: '+n+';">City Funded Amount: </b>'+t["City Funded Amount"]+"</div>"),this.bindPopup(a),this.openPopup()}function r(e,t,a){var o=0;for(n in e){var i=e[n];if(!_.isUndefined(i[t])&&!_.isNull(i[t])){var r=i[t];_.isUndefined(a)||(r=a(r)),o+=r}}return o}function l(e){var t={};for(var a in e){var n=e[a];if(!_.isUndefined(n["Kirwan Opportunity Index"])&&!_.isNull(n["Kirwan Opportunity Index"])&&n["Kirwan Opportunity Index"].length>0&&!_.isUndefined(n["Total Affordable Units"])&&n["Total Affordable Units"]>=0&&!_.isUndefined(n["Market Rate Units"]&&n["Market Rate Units"])){var o=n["Kirwan Opportunity Index"];o in t||(t[o]={market:0,affordable:0}),o in t&&(t[o].market=n["Market Rate Units"],t[o].affordable=n["Total Affordable Units"])}}return t}function s(e,t){var a={};for(var n in e){var o=e[n];if(!_.isUndefined(o.Program&&!_.isNull(o.Program))&&!_.isUndefined(o["Total Affordable Units"])&&o["Total Affordable Units"]>=0){var i=o.Program;i in a||(a[i]={affordable:0,cityFundedAmount:0}),i in a&&(a[i].affordable=a[i].affordable+o["Total Affordable Units"],a[i].cityFundedAmount=a[i].cityFundedAmount+t(o["City Funded Amount"]))}}return a}function u(e,t){var a={};for(var n in e){var o=e[n];if(!isUndefinedOrNull(o.Developer&&!isUndefinedOrNull(o["Total Affordable Units"]))){var i=o.Developer;i in a||(a[i]={affordable:0,cityFundedAmount:0,RHDA:0,AD:0,Incentive:0,devName:i,veryLow:0,low:0,moderate:0,high:0,veryHigh:0,total:0}),i in a&&(a[i].affordable=a[i].affordable+o["Total Affordable Units"],isUndefinedOrNull(o["City Funded Amount"])||(a[i].cityFundedAmount=a[i].cityFundedAmount+t(o["City Funded Amount"])),"RHDA"==o.Program&&(a[i].RHDA=a[i].RHDA+o["Total Affordable Units"]),"A&D"==o.Program&&(a[i].AD=a[i].AD+o["Total Affordable Units"]),"Devloper Incentive"==o.Program&&(a[i].Incentive=a[i].Incentive+o["Total Affordable Units"]),"Very Low"==o["Kirwan Opportunity Index"]&&(a[i].veryLow=a[i].veryLow+o["Total Affordable Units"]),"Low"==o["Kirwan Opportunity Index"]&&(a[i].low=a[i].low+o["Total Affordable Units"]),"Moderate"==o["Kirwan Opportunity Index"]&&(a[i].moderate=a[i].moderate+o["Total Affordable Units"]),"High"==o["Kirwan Opportunity Index"]&&(a[i].high=a[i].high+o["Total Affordable Units"]),"Very High"==o["Kirwan Opportunity Index"]&&(a[i].veryHigh=a[i].veryHigh+o["Total Affordable Units"]),a[i].total=a[i].total+o["Total Units"])}}var r=[];for(var l in a)r.push(a[l]);return _.sortBy(r,"affordable").reverse()}function c(){$("#data-content").toggle(!1),$("#loader").toggle(!0)}function f(){setTimeout(function(){$("#data-content").toggle(!0),$("#loader").toggle(!1)},1e3)}function p(e,t,a){var n=function(e){return parseFloat(e.replace("$",""))},d=u(e,n);c();var p=new L.FeatureGroup;if(a)m=o(e,a);else var m=e;m=o(m,function(e){function t(e,t,a){return a>=e&&a<=t}function a(e){var t=83e3,a=$("#household-yearly-income").val();if(a){var n=parseFloat(a/t*100),o=[];n<80&&o.push(80),n<60&&o.push(60),n<50&&o.push(50),n<40&&o.push(40);var i=0;return _.contains(o,80)||(i+=e["Units <= 80% MFI"]),_.contains(o,60)||(i+=e["Units <= 80% MFI"]),_.contains(o,60)||(i+=e["Units <= 60% MFI"]),_.contains(o,50)||(i+=e["Units <= 50% MFI"]),_.contains(o,40)||(i+=e["Units <= 40% MFI"]),(i+=e["Units <= 30% MFI"])>0}return!0}var n=new Date($("#datepicker1").val()),o=new Date($("#datepicker2").val());return(!_.isUndefined(e["Affordability Expiration Date"])||!_.isNull(e["Affordability Expiration Date"]))&&!(!t(n,o,new Date(e["Affordability Expiration Date"]))||!a(e))}),A=m;var v=0,b=r(m,"Total Affordable Units"),y=r(m,"Market Rate Units"),h=r(m,"Units <= 30% MFI"),w=r(m,"Units <= 40% MFI"),U=r(m,"Units <= 50% MFI"),k=r(m,"Units <= 60% MFI"),I=(r(m,"Units <= 80% MFI"),r(m,"City Funded Amount",n));$("#city-funded-amount-total").text(I);var D=l(m),F=s(m,n);for(var T in m){var x=m[T];if(x.Location&&x.Location.length>0){var C=x.Location.match(/\d*\.\d*/g),O=L.marker([parseFloat(C[0]),-parseFloat(C[1])],{icon:g()});O.markerID=T,O.on("click",i),p.addLayer(O),v+=1}}t.addLayer(p),$("#AFI-Total").text(v),$("#AFI-Affordable").text(b),$("#AFI-Market-Rate-Units").text(y);var M=550;return google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["<= 30% MFI",h],["<= 40% MFI",w],["<= 50% MFI",U],["<= 60% MFI",k]]);var t={title:"Affordable Housing By Income Level",width:M,height:300};new google.visualization.ColumnChart(document.getElementById("chart_div")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["Very Low",isUndefinedOrNull(D["Very Low"])?0:D["Very Low"].affordable],["Low",isUndefinedOrNull(D.Low)?0:D.Low.affordable],["Moderate",isUndefinedOrNull(D.Moderate)?0:D.Moderate.affordable],["High",isUndefinedOrNull(D.High)?0:D.High.affordable],["Very High",isUndefinedOrNull(D["Very High"])?0:D["Very High"].affordable]]);var t={title:"Affordable Housing By Kirwan Opportunity Index",width:M,height:300,colors:["orange"],legend:"right"};new google.visualization.ColumnChart(document.getElementById("chart-kirwan")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Level"),e.addColumn("number","Units"),e.addRows([["RHDA",isUndefinedOrNull(F.RHDA)?0:F.RHDA.affordable],["A&D",isUndefinedOrNull(F["A&D"])?0:F["A&D"].affordable],["Developer Incentive",isUndefinedOrNull(F["Developer Incentive"])?0:F["Developer Incentive"].affordable]]);var t={title:"Affordable Housing By Program Type",width:M,height:300,colors:["red"]};new google.visualization.ColumnChart(document.getElementById("chart-program")).draw(e,t)}),google.charts.setOnLoadCallback(function(){var e=new google.visualization.DataTable;e.addColumn("string","Developer Name"),e.addColumn("number","City Funded Amount ($)"),e.addColumn("number","Affordable Units"),e.addColumn("number","Total Units"),e.addColumn("number","City Cost Per Unit");var t=[];for(T in d){var a=d[T],n=0;a.cityFundedAmount>0&&a.total>0&&(n=parseFloat((a.cityFundedAmount/a.total).toFixed(2))),t.push([a.devName,a.cityFundedAmount,a.affordable,a.total,n])}e.addRows(t),new google.visualization.Table(document.getElementById("developer_table")).draw(e,{showRowNumber:!0,width:"100%",height:"500px"});var o=$(".google-visualization-table-table > tbody > tr");$.each(o,function(){var e=$(this).children("td"),t=e[e.length-1];parseFloat($(t).text())>0&&$(t).css("background-color","#5cb85c")}),$("#developer_table").off(),$("#developer_table").click(function(){var e=$(".google-visualization-table-table > tbody > tr");$.each(e,function(){var e=$(this).children("td"),t=e[e.length-1];parseFloat($(t).text())>0&&$(t).css("background-color","#5cb85c")})})}),f(),p}function m(e,t){t.removeLayer(e)}function g(e){return v()}function v(e){return L.AwesomeMarkers.icon({markerColor:"blue"})}window.loginPass=null;var b=null;$.ajax({type:"GET",url:"https://freegeoip.net/json/?callback",success:function(t){b=t,e("IP DATA ONLY")},error:function(){}}),$('[data-toggle="tooltip"]').tooltip({}),$("#submit-login").click(function(){window.loginPass=$("#pass-input").val(),$.ajax({type:"POST",url:"/login",data:{pass:$("#pass-input").val()},success:function(e){$("#main-app").toggle(!0),$("#login").toggle(!1),t()},error:function(){}})});var y={show_email:!0,show_name:!1,position:"right-top",email_placeholder:"Email goes here (optional)",message_placeholder:"Go ahead, type your feedback here...",name_required:!1,message_required:!0,message_label:"Questions, comments, suggestions?",show_asterisk_for_required:!0,feedback_url:"send_feedback",delayed_options:{delay_success_milliseconds:3500,send_success:"Sent successfully :)"}};fm.init(y),$(".feedback_trigger").css("color","white"),$(".feedback_trigger").css("background","green"),$(".feedback_trigger").css("height","105px"),$(".feedback_content").css("border","2px solid black"),$(".feedback_submit").css("background","green"),f(),google.charts.load("current",{packages:["corechart","table"]});var h=null,A=[];mymap=null;var w=null});
